<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{$title}</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="/static/css/common/reset.css">
    <script src="/static/js/jquery-2.0.3.min.js"></script>
    <script src="/static/js/wap_flexible.js"></script>
    <link rel="stylesheet" href="/static/css/login.css">
    <link rel="stylesheet" href="/static/elementui/element-ui.css">
</head>
<style>
    .el-message {
        min-width: 300px !important
    }
</style>

<body>
    <session class="login-box font-size-14">
        <div class="login-content bg-fff border-radius4" id='el-app'>
            <div class="font-text-center font-size-20 mab10">律者登录</div>
            <div class="login-type font-size-14">
                <div class="login-type-item font-text-center active logon-type-line" @click="loginType='verify'">普通登录</div>
                <div class="login-type-item font-text-center" @click="loginType='code'">手机号登录</div>
            </div>
            <div class="tel border-radius4 mab20">
                <input type="text" maxlength="11" v-model='form.account' placeholder="请输入手机号" class="telInput border-radius4">
            </div>
            <div class="input-type-wrapper">
                <div class="pass-input border-radius4 mab30 logon-type-mean active">
                    <input type="password" v-model='form.password' placeholder="请输入密码" class="passInput border-radius4">
                </div>
                <div class="mab30 logon-type-mean">
                    <div class="pass-verif">
                        <div class="pass-input border-radius4 mar10 flex1">
                            <input type="text" placeholder="请输入验证码" v-model='form.code' class="passInput border-radius4">
                        </div>
                        <div class="send-code border-radius4 font-color-fff" v-text="codeText" :disabled="codeStatus" :class="codeClass" @click="sendCode()" id="getCode">发送验证码</div>
                    </div>
                </div>
            </div>
            <div class="login-btn font-color-fff border-radius4 font-text-center" @click="login(loginType)">登录</div>
        </div>
        <img src="/static/images/flash.png" alt="" class="bottom-pic">
    </session>
    <script src="/static/js/vue.js"></script>
    <script src="/static/elementui/element-ui.js"></script>
    <script>
        var redirectUrl = "{:request()->param('redirectUrl')}";
        var app = new Vue({
            delimiters: ['${', '}'],
            el: '#el-app',
            data() {
                return {
                    loginType: 'verify',
                    email: '',
                    codeText: '发送验证码',
                    codeClass: "",
                    codeStatus: false,
                    loading: false,
                    captcha: "{:captcha_src()}",
                    form: {
                        account: '',
                        password: '',
                        code: '',
                        captcha: ''
                    }
                }
            },
            methods: {
                sendCode() {
                    var that = this;
                    if ($('#getCode').hasClass('gray-bg')) {
                        return false;
                    }
                    if (!(/^1[3456789]\d{9}$/.test(this.form.account))) {
                        return this.$message.error('手机号不正确');
                    }
                    $.post("{:url('index/sendCode')}", {
                        account: this.form.account
                    }, function(res) {
                        if (res.code == 0) {
                            that.$message({
                                message: res.msg,
                                type: 'success'
                            });
                            that.codeStatus = true;
                            var time = 60;
                            that.setTime(time);
                            that.codeText = '' + time + 's后重新发送';
                        } else {
                            that.$message.error(res.msg);
                        }
                    })
                },
                login(type) {
                    var field = this.form;
                    var that = this;
                    if (type == 'verify') {
                        if (field.password == '' || field.password.length < 6) {
                            return this.$message.error('密码格式不正确');
                        }
                    } else {
                        if (field.code == '') {
                            return this.$message.error('手机号不正确');
                        }
                    }
                    field.loginType = type;
                    field.redirectUrl = redirectUrl;
                    field.isType = "{:request()->param('isType')}";
                    $.post("{:url('index/login')}", field, function(res) {
                        if (res.code == 0) {
                            that.$message({
                                message: res.msg,
                                type: 'success'
                            });
                            window.location.href = res.data;
                        } else {
                            that.$message.error(res.msg);
                        }
                    })
                },
                setTime(time) {
                    var that = this;
                    that.codeClass = 'gray-bg';
                    timeClock = setInterval(function() {
                        time--;
                        that.codeText = '' + time + 's后重新发送';
                        if (time == 0) {
                            that.codeClass = '';
                            clearInterval(timeClock);
                            that.codeText = '发送验证码';
                            that.codeStatus = false;
                        }
                    }, 1000)
                },
                getCaptcha() {
                    this.captcha = "{:captcha_src()}?t=" + new Date().getTime();
                }
            }

        })
        $(function() {
            //登录列表切换
            $('.login-type').on('click', 'div', function() {
                var index = $(this).index();
                $('.login-type div').eq(index).addClass('active').siblings().removeClass('active');
                $('.input-type-wrapper .logon-type-mean').eq(index).fadeIn().siblings().fadeOut(0);
            });

        });

        //序列化url，将url链接后面的get参数序列化成json对象
        function parseUrl(field, urlstr) {
            if (typeof(urlstr) === 'undefined') {
                urlstr = window.location.href;
            }
            var param = urlstr.substring(urlstr.indexOf("?") + 1);
            var paramArr = param.split("&");
            var urlArr = {};
            for (var i = 0; i < paramArr.length; i++) {
                var str = paramArr[i];
                var itemArr = str.split("=");
                urlArr[itemArr[0]] = itemArr[1];
            }
            if (typeof(urlArr[field]) === 'undefined') {
                return '';
            }
            return urlArr[field];
        }
    </script>
</body>

</html>