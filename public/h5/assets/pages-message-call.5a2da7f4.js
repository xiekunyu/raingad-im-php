import{_ as a,q as t,s,l as e,aa as i,$ as d,x as n,N as l,ab as c,O as o,o as m,c as h,w as g,i as r,f as p,ac as u}from"./index-88b4c777.js";const C=t(s),{userInfo:y}=e(C);const _=a({data:()=>({html:"",postMsg:null,webview:null,Frames:null,mainFrame:null,contact:null,type:!1,wsData:null,msg_id:null}),onReady(){},onLoad:function(a){let t="h5";t="h5",this.msg_id=a.msg_id,this.html="/hybrid/html/index.html?id="+y.value.user_id+"&status="+a.status+"&name="+a.name+"&target_id="+a.id+"&type="+a.type+"&platform=h5&avatar="+a.avatar,this.type=a.type,this.status=a.status,this.contact={id:a.id,displayName:a.name,avatar:a.avatar},setTimeout((()=>{this.Frames=document.getElementsByTagName("iframe"),this.mainFrame=this.Frames[0].contentWindow,this.postMsg=this.h5sendH5}),500),window.onmessage=a=>{this.msgCallback(a)},i("webrtcConn"),d("webrtcConn",(a=>{this.msg_id==a.msg_id?(this.wsData=a,this.postMsg(JSON.parse(JSON.stringify(a.extends)),"*")):this.$api.msgApi.sendToMsg({toContactId:a.fromUser.user_id,type:a.extends.type,event:"busy",status:a.extends.status,code:907,id:a.id,msg_id:a.msg_id})}))},methods:{message(a){const t={data:a.detail.data[0]};this.msgCallback(t)},appsendH5(a){a.iceCandidate&&a.iceCandidate.length>0&&(a.iceCandidate=JSON.parse(a.iceCandidate)),this.webview.evalJS("getUniAppMessage('"+JSON.stringify(a)+"')")},h5sendH5(a){this.mainFrame.postMessage(a,"*")},msgCallback(a){let t="",s="";this.wsData&&(s=this.wsData.id??"");let e=!0;switch(a.data.event){case"hangup":this.closeCall(),907==a.data.code&&n({title:"对方忙~~",icon:"none"}),a.data.isbtn||(e=!1);break;case"iceCandidate":console.log("监听同步ice");let s={};s.candidate=a.data.iceCandidate.candidate,s.sdpMLineIndex=a.data.iceCandidate.sdpMLineIndex,s.sdpMid=a.data.iceCandidate.sdpMid,t=JSON.stringify(s)}e&&this.$api.msgApi.sendToMsg({id:s,msg_id:this.msg_id,toContactId:this.contact.id,type:this.type,event:a.data.event,status:a.data.status??"",code:a.data.code??"",callTime:a.data.callTime??"",sdp:a.data.sdp??"",iceCandidate:t})},closeCall(){l().length>1?c():o({url:"/pages/index/index"})}}},[["render",function(a,t,s,e,i,d){const n=u,l=r;return m(),h(l,{class:""},{default:g((()=>[p(n,{onMessage:d.message,src:i.html},null,8,["onMessage","src"])])),_:1})}],["__scopeId","data-v-9b856648"]]);export{_ as default};
