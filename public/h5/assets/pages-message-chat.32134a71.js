import{_ as e,o as t,c as s,j as i,l as o,s as a,u as n,A as c,B as l,C as r,D as d,E as u,q as m,p as h,w as p,g,f,h as y,G as x,i as _,t as k,n as w,d as b,e as I,F as C,H as T,I as v,J as M,b as S,y as B,S as U,v as j,x as L,K as R,m as H,L as N,a as E,M as $,$ as F,N as O,O as D,P,Q as A,R as z,r as V,k as J,T as q}from"./index-4eea144c.js";import{_ as G}from"./uni-load-more.e9bb9bbb.js";import{r as K}from"./uni-app.es.b3d97fb4.js";import{e as Q,s as W,_ as Y}from"./status.76301cbd.js";const X=e({data:()=>({isUserMedia:!1,stream:null,audio:null,recorder:null,chunks:[],startTime:0}),mounted(){if(-1===origin.indexOf("https")&&-1===origin.indexOf("localhost")&&-1===origin.indexOf("127.0.0.1"))throw this.$emit("error","100"),"请在 https 环境中使用本插件。";if(!navigator.mediaDevices||!window.MediaRecorder)throw this.$emit("error","101"),"当前浏览器不支持";this.getRecorderManager()},methods:{getRecorderManager(){this.audio=document.createElement("audio"),navigator.mediaDevices.getUserMedia({audio:!0}).then((e=>{this.isUserMedia=!0,e.getTracks().forEach((e=>{e.stop()}))})).catch((e=>{this.onErrorHandler(e)}))},start(){if(!this.isUserMedia)return console.log("设备不支持");navigator.mediaDevices.getUserMedia({audio:!0}).then((e=>{this.startTime=(new Date).getTime(),this.stream=e,this.recorder=new MediaRecorder(e),this.recorder.ondataavailable=this.getRecordingData,this.recorder.onstop=this.saveRecordingData,this.recorder.start()})).catch((e=>{this.onErrorHandler(e)}))},stop(){this.recorder.stop(),this.stream.getTracks().forEach((e=>{e.stop()}))},getRecordingData(e){this.chunks.push(e.data)},saveRecordingData(){const e=new Blob(this.chunks,{type:"audio/mpeg"}),t=URL.createObjectURL(e);this.chunks=[];let s=((new Date).getTime()-this.startTime).toString().split("");s.splice(s.length-2),s.splice(s.length-1,0,"."),s=parseFloat(s.join(""));const i={data:e,duration:s,localUrl:t};this.$emit("success",i)},onErrorHandler(e){if(console.log(e),"NotAllowedError"===e.name)throw this.$emit("error","201"),"用户拒绝了当前的浏览器实例的访问请求";if("NotReadableError"===e.name)throw this.$emit("error","101"),"当前浏览器不支持";throw this.$emit("error","500"),"调用失败，原因不详"}},destroyed(){this.stop()}},[["render",function(e,o,a,n,c,l){const r=i;return t(),s(r,{class:"recorder"})}]]),Z=o(a),ee=n(a);const te=e({name:"im-input",components:{MumuRecorder:X},props:{boxStatus:{type:Number,default:0},contact:{type:Object,default:{}}},data:()=>({InputBottom:0,paddingB:0,footerHeight:50,boxHeight:300,uploading:!1,recShow:!1,inputMsg:"",recorderManager:null,recing:!1,recLength:1,recTimer:null,tmpVoice:"",isUseRecorder:!1,playItemIndex:-1,currentAudio:"",mainHeight:0,isCancel:!1,isH5:!1,isApp:!1,appBox:0,TabCur:0,scrollLeft:0,emojiList:[],currentEmojiList:[],isFocus:!1,globalConfig:ee.globalConfig}),watch:{boxStatus(e){this.appBox=0,this.InputBottom=0},appBox(e){0!=e||this.isFocus||(this.InputBottom=0)},InputBottom(e){this.$emit("setPad",e)}},created:function(){this.emojiList=Q,this.currentEmojiList=Q[0].children,c({success:e=>{let t=e.windowHeight;this.mainHeight=t}}),this.isH5=!0},methods:{msgItem(){return{id:this.$util.getUuid(),sendTime:(new Date).getTime(),status:"going",type:"text",content:"",is_read:0,is_group:0,file_id:0,file_cate:0,fileName:"",fileSize:0,extends:null}},chooseEmoji(e){let t="[!"+e.name+"]";this.inputMsg+=t},tabSelect(e){this.TabCur=e.currentTarget.dataset.id,this.scrollLeft=60*(e.currentTarget.dataset.id-1),this.currentEmojiList=this.emojiList[this.TabCur].children},showAppBox(e){this.appBox==e?(this.appBox=0,this.InputBottom=0):(this.appBox=e,this.InputBottom=this.boxHeight,this.recShow=!1)},showRec:function(){this.InputBottom=0,this.appBox=0,1==this.recShow?this.recShow=!1:this.recShow=!0},sendVoiceMsg:function(){if(""==this.tmpVoice)return void l({title:"录制已取消",icon:"none"});let e={localUrl:this.tmpVoice,duration:this.recLength};this.handlerSuccess(e),this.tmpVoice="",this.recLength=0},sendTextMsg:function(){if(1!=this.appBox&&(this.isFocus=!0),""==this.inputMsg)return!1;let e={type:"text",content:this.inputMsg};this.inputMsg="",this.$emit("send",Object.assign(this.msgItem(),e),"")},chooseImg(){let e={type:"image",status:"going"};r({count:9,sizeType:["compressed"],sourceType:["album","camera"],success:t=>{t.tempFiles.forEach((t=>{e.content=t.path,e.fileName=t.name,e.fileSize=t.size,this.$emit("send",Object.assign(this.msgItem(),e),t.path)}))}})},chooseVideo:function(){let e={type:"video",status:"going"};d({sourceType:["camera","album"],success:t=>{if(t.duration>60)return l({title:"视频长度不能超过60秒",icon:"error"});const s=t.tempFilePath;let i={duration:t.duration,width:t.width,height:t.height};e.fileName=t.name,e.fileSize=t.size,e.extends=i,e.content=s,this.$emit("send",Object.assign(this.msgItem(),e),s)}})},chooseFile:function(){let e=this;u({count:5,success:function(t){e.appendFile(t)}})},appendFile(e){e.tempFiles.forEach((e=>{let t={type:"file",status:"going",fileName:e.name,fileSize:e.size,content:e.path},s=e.type;-1!=s.indexOf("image/")&&(t.type="image"),-1!=s.indexOf("video/")&&(t.type="video"),t.content=e.path,this.$emit("send",Object.assign(this.msgItem(),t),e.path)}))},chooseProject:()=>l({title:"自己扩展呗~~"}),calling(e){if(!parseInt(this.globalConfig.chatInfo.webrtc))return l({title:"未开启音视频通话",icon:"none"});if(Z.webrtcLock)return l({title:"其他终端正在通话中",icon:"none"});let t=this.$util.getUuid();m({url:"/pages/message/call?msg_id="+t+"&type="+e+"&status=1&id="+this.contact.id+"&name="+this.contact.displayName+"&avatar="+encodeURI(this.contact.avatar)})},InputFocus(e){this.isFocus=!0,this.appBox>0&&(this.appBox=0),this.InputBottom=0},InputBlur(e){this.appBox||this.isFocus||(this.InputBottom=0),this.isFocus=!1},startRecorder(){console.log("录音开始..."),this.$refs.recorderRef.start(),this.isUseRecorder=!0},endRecorder(){console.log("录音结束"),this.$refs.recorderRef.stop(),this.isUseRecorder=!1},cancelRecorder(){this.endRecorder(),this.isCancel=!0},moveRecorder(e){e.touches[0].clientY<this.mainHeight-80?this.isCancel=!0:this.isCancel=!1},handlerSuccess(e){if(this.checkRecorder(e.duration),this.isCancel)return this.isCancel=!1,console.log("录音已取消");let t={type:"voice",content:e.localUrl,fileName:this.$util.getUuid()+".mp3",extends:{duration:e.duration}};this.$emit("send",Object.assign(this.msgItem(),t))},checkRecorder(e){if(e<1||isNaN(e)||!e)return this.recLength=0,this.tmpVoice="",this.recing=!1,this.isCancel=!0,l({title:"录音时间太短",icon:"error"})},handlerError(e){switch(e){case"101":h({content:"当前浏览器版本较低，请更换浏览器使用，推荐在微信中打开。"});break;case"201":h({content:"麦克风权限被拒绝，请刷新页面后授权麦克风权限。"});break;default:console.log("录音功能受限，请知晓！")}}}},[["render",function(e,o,a,n,c,l){const r=i,d=M,u=K(S("mumu-recorder"),X),m=B,h=U,L=j;return t(),s(r,{id:"more-oprate"},{default:p((()=>[g(r,{class:"im-footer bg-gray",style:w([{paddingBottom:c.paddingB+"px",height:c.footerHeight+"px",bottom:c.InputBottom+"px"}])},{default:p((()=>[g(r,{class:f(["im-menus f-28",[c.recShow?"cuIcon-keyboard":"cuIcon-sound"]]),"hover-class":"tap",onClick:l.showRec},null,8,["class","onClick"]),0==c.recShow?(t(),s(d,{key:0,class:"solid-bottom im-flex1 bg-white im-input",type:"text",modelValue:c.inputMsg,"onUpdate:modelValue":o[0]||(o[0]=e=>c.inputMsg=e),"adjust-position":!1,focus:c.isFocus,maxlength:"300","cursor-spacing":"10",onFocus:l.InputFocus,onBlur:l.InputBlur,onConfirm:l.sendTextMsg,"confirm-type":"send","confirm-hold":!0},null,8,["modelValue","focus","onFocus","onBlur","onConfirm"])):y("",!0),1==c.recShow?(t(),s(r,{key:1,class:"toolBox im-flex1"},{default:p((()=>[g(r,{class:f(["recorder",{active:c.isUseRecorder}]),onTouchstart:x(l.startRecorder,["prevent"]),onTouchend:x(l.endRecorder,["prevent"]),onTouchmove:x(l.moveRecorder,["prevent"]),onTouchcancel:l.cancelRecorder},{default:p((()=>[_(k(c.isUseRecorder?"松开结束":"按住说话"),1)])),_:1},8,["class","onTouchstart","onTouchend","onTouchmove","onTouchcancel"])])),_:1})):y("",!0),c.isH5?(t(),s(u,{key:2,ref:"recorderRef",onSuccess:l.handlerSuccess,onError:l.handlerError},null,8,["onSuccess","onError"])):y("",!0),g(r,{class:"im-flex im-justify-content-start im-align-items-center"},{default:p((()=>[g(r,{class:"im-menus cuIcon-emoji f-28","hover-class":"tap",onClick:o[1]||(o[1]=e=>l.showAppBox(1))}),c.inputMsg?y("",!0):(t(),s(r,{key:0,class:"im-menus cuIcon-roundadd f-28 mr-10","hover-class":"tap",onClick:o[2]||(o[2]=e=>l.showAppBox(2))})),c.inputMsg?(t(),s(r,{key:1},{default:p((()=>[g(m,{class:"cu-btn bg-green shadow mr-10",onClick:l.sendTextMsg},{default:p((()=>[_("发送")])),_:1},8,["onClick"])])),_:1})):y("",!0)])),_:1}),1==c.appBox?(t(),s(r,{key:3,class:"im-flex im-columns im-emoji-box",style:w([{height:c.boxHeight+"px"}])},{default:p((()=>[g(h,{"scroll-x":"",class:"bg-gray nav im-emoji-header","scroll-with-animation":"","scroll-left":c.scrollLeft},{default:p((()=>[(t(!0),b(C,null,I(c.emojiList,((e,i)=>(t(),s(r,{class:f(["cu-item",i==c.TabCur?"text-green":""]),key:i,onClick:l.tabSelect,"data-id":i},{default:p((()=>[g(r,{class:f([[e.icon],"f-20"])},null,8,["class"])])),_:2},1032,["class","onClick","data-id"])))),128))])),_:1},8,["scroll-left"]),g(h,{"scroll-y":"",class:"bg-white im-emoji-body"},{default:p((()=>[g(r,{class:"im-flex im-wrap im-justify-content-start im-align-items-center pd-10"},{default:p((()=>[(t(!0),b(C,null,I(c.currentEmojiList,((e,i)=>(t(),s(r,{class:"im-emoji-item"},{default:p((()=>[g(L,{src:e.src,style:{width:"44rpx"},mode:"widthFix",onClick:t=>l.chooseEmoji(e)},null,8,["src","onClick"])])),_:2},1024)))),256))])),_:1})])),_:1})])),_:1},8,["style"])):y("",!0),2==c.appBox?(t(),s(r,{key:4,class:"im-flex im-app-box im-flex im-justify-content-start im-wrap im-align-content-start pd-20",style:w([{height:c.boxHeight+"px"}])},{default:p((()=>[g(r,{class:"im-flex im-columns im-align-items-center mt-10 im-app-item",onClick:l.chooseImg},{default:p((()=>[g(r,{class:"bg-white cuIcon-album f-24 radius-10 im-app-item-icon"}),g(r,{class:"mt-5"},{default:p((()=>[_("照片")])),_:1})])),_:1},8,["onClick"]),g(r,{class:"im-flex im-columns im-align-items-center mt-10 im-app-item",onClick:l.chooseVideo},{default:p((()=>[g(r,{class:"bg-white cuIcon-video f-24 radius-10 im-app-item-icon"}),g(r,{class:"mt-5"},{default:p((()=>[_("视频")])),_:1})])),_:1},8,["onClick"]),c.isApp?y("",!0):(t(),s(r,{key:0,class:"im-flex im-columns im-align-items-center mt-10 im-app-item",onClick:l.chooseFile},{default:p((()=>[g(r,{class:"bg-white cuIcon-file f-24 radius-10 im-app-item-icon"}),g(r,{class:"mt-5"},{default:p((()=>[_("文件")])),_:1})])),_:1},8,["onClick"])),!a.contact.is_group&&(c.isH5||c.isApp)&&parseInt(c.globalConfig.chatInfo.webrtc)?(t(),s(r,{key:1,class:"im-flex im-columns im-align-items-center mt-10 im-app-item",onClick:o[3]||(o[3]=e=>l.calling(0))},{default:p((()=>[g(r,{class:"bg-white cuIcon-dianhua f-24 radius-10 im-app-item-icon"}),g(r,{class:"mt-5"},{default:p((()=>[_("语音通话")])),_:1})])),_:1})):y("",!0),!a.contact.is_group&&(c.isH5||c.isApp)&&parseInt(c.globalConfig.chatInfo.webrtc)?(t(),s(r,{key:2,class:"im-flex im-columns im-align-items-center mt-10 im-app-item",onClick:o[4]||(o[4]=e=>l.calling(1))},{default:p((()=>[g(r,{class:"bg-white cuIcon-record f-24 radius-10 im-app-item-icon"}),g(r,{class:"mt-5"},{default:p((()=>[_("视频通话")])),_:1})])),_:1})):y("",!0),g(r,{class:"im-flex im-columns im-align-items-center mt-10 im-app-item",onClick:l.chooseProject},{default:p((()=>[g(r,{class:"bg-white cuIcon-apps f-24 radius-10 im-app-item-icon"}),g(r,{class:"mt-5"},{default:p((()=>[_("项目")])),_:1})])),_:1},8,["onClick"]),g(r,{class:"im-flex im-columns im-align-items-center mt-10 im-app-item",onClick:l.chooseProject},{default:p((()=>[g(r,{class:"bg-white cuIcon-friend f-24 radius-10 im-app-item-icon"}),g(r,{class:"mt-5"},{default:p((()=>[_("客户")])),_:1})])),_:1},8,["onClick"])])),_:1},8,["style"])):y("",!0)])),_:1},8,["style"]),T(g(r,{class:"voice-model c-white radius-10 im-flex im-columns im-align-items-center pd-10"},{default:p((()=>[g(r,{class:f(["cuIcon-voicefill mt-15 mb-5 f-28",[c.isCancel?"c-red":""]])},null,8,["class"]),g(r,{class:f([c.isCancel?"c-red":""])},{default:p((()=>[_(k(c.isCancel?"松开取消":"正在录音..."),1)])),_:1},8,["class"])])),_:1},512),[[v,c.isUseRecorder]])])),_:1})}],["__scopeId","data-v-0c42b4d4"]]);const se=e({name:"im-item",components:{},props:{item:{type:Object,default:function(){return{}}},index:{type:Number,default:0},isSelf:{type:Boolean,default:!1}},data:()=>({}),created:function(){},methods:{}},[["render",function(e,o,a,n,c,l){const r=i;return"diy"==a.item.type?(t(),s(r,{key:0,item:a.item,index:a.index,isSelf:a.isSelf},{default:p((()=>[_(" 自定义 ")])),_:1},8,["item","index","isSelf"])):(t(),s(r,{key:1},{default:p((()=>[_(" 暂不支持该消息类型 ")])),_:1}))}]]),ie=L("userInfo"),oe=L("appSetting");const ae=e({name:"im-touch",props:{info:{type:Object,default:function(){return{}}},circleAvatar:{type:Boolean,default:!1}},data:()=>({toucheTimer:0,fingerRes:[],distance:0,taptimer:100,appSetting:oe}),methods:{openUserInfo(e){e.id!=ie.user_id&&m({url:"/pages/contacts/detail?id="+this.info.id})}}},[["render",function(e,o,a,n,c,l){const r=i;return t(),s(r,{class:f(["cu-avatar lg",c.appSetting.circleAvatar?"round":"radius"]),onClick:o[0]||(o[0]=e=>l.openUserInfo(a.info)),style:w([{backgroundImage:"url("+a.info.avatar+")"}])},null,8,["class","style"])}]]),ne=R(),ce=o(a),{newMessage:le,msgList:re,getContact:de,appendMsg:ue,checkMsg:me}=H(ce),he=n(a);const pe=e({components:{imInput:te,imItem:se,imUser:ae,statusPoint:W},data:()=>({user:he.userInfo,contact:{},is_group:0,boxStatus:0,paddingT:0,videoUrl:"",videoModel:!1,InputBottom:0,player:null,playIndex:-1,emojiMap:[],fileExt:[],page:1,limit:20,moreData:!0,newMessage:le,messageList:re,newheight:0,scrollTop:0,loading:"more",loadLock:!1,scrollHeight:0,paddingB:0,contact_id:0,bottomHeight:50,globalConfig:he.globalConfig,modelName:"",curMsg:"",isSending:!1,copyTxt:"文本",wsData:null,timer:null}),computed:{scrollH:function(){let e=N(),t=750/e.windowWidth,s=E(100);this.bottomHeight=s;const i=$().in(this);return setTimeout((()=>{i.select(".cu-header").boundingClientRect(),i.exec((e=>{this.paddingT=e[0].height}))}),10),parseInt((e.windowHeight-this.navBarHeight-this.paddingT)*t)}},watch:{newMessage(e){e.toContactId==this.contact.id&&e.fromUser.id!=this.user.user_id&&this.$api.msgApi.setMsgIsRead({toContactId:this.contact.id,is_group:this.contact.is_group,messages:e,fromUser:e.fromUser.id}),this.scrollToBottom()}},onLoad(e){let t=ce.getContact(e.id);this.contact=t,this.contact_id=e.id,this.is_group=t.is_group,this.getMessageList(),F("getPositonsOrder",(e=>{let t=e.data;switch(e.type){case"isRead":for(let o=0;t.length>o;o++){const e={id:t[o].id,is_read:1};this.updateMessage(e)}break;case"isOnline":t.id==this.contact.id&&(this.contact.is_online=t.is_online);break;case"undoMessage":this.updateMessage(t);break;case"simple":case"group":case"webrtc":O();let e={},s=location.href;if(e=this.$util.parseUrl(s),"webrtc"==t.type){if(!["calling","hangup","otherOpt"].includes(t.extends.event))return!1;"calling"==t.extends.event&&(this.wsData=t);let e=parseInt(t.extends.code);if([902,903,904,905,906,907].includes(e)){let e=this.wsData||t;e.content=t.content,t=e}}let i=!1;1==t.is_group?t.toUser==e.id&&(i=!0):t.toContactId!=e.id&&t.fromUser.id!=this.user.user_id||(i=!0),i&&(ce.checkMsg(t),ce.appendMsg(t)),this.scrollToBottom()}}))},onBackPress(e){return this.InputBottom=0,D({url:"/pages/index/index"}),!0},onShow(){this.socketIo.send({type:"ping"})},created:function(){let e=[];Q.forEach((function(t){let s=t.children;s.length>0&&s.forEach((function(t){let s=t.name,i=t.src;e[s]=i}))})),this.emojiMap=e,ne.onPlay((()=>{console.log("play")})),ne.onEnded((()=>{console.log("播放完毕，继续播放下一个录音！");var e=Number(this.playIndex);for(let t=e+1;t<this.messageList.length;t++)if("voice"==this.messageList[t].type){this.playNow(this.messageList[t].content,t);break}this.messageList.length<=e+1&&(ne.stop(),this.playIndex=-1)})),ne.onError((e=>{console.log(e)}))},methods:{calling(e){this.$refs.imInput.calling(parseInt(e))},endTimer(){clearTimeout(this.timer)},getTime:()=>(new Date).getTime(),setPad(e){this.paddingB=e,this.scrollToBottom()},updateMessage(e){let t=this.messageList;t.forEach(((s,i)=>{let o=t[i];s.id==e.id&&(t[i]=Object.assign(o,e))})),this.messageList=t},getScrollHeight(){const e=$().in(this);setTimeout((()=>{e.select(".cu-chat").boundingClientRect(),e.exec((e=>{this.scrollHeight=e[0].height,this.scrollTop=e[0].height-this.newheight,this.loadLock=!1}))}),10)},scrollChat(e){this.newheight=e.detail.scrollHeight,e.detail.scrollTop<10&&0==this.loadLock&&(this.loadLock=!0,this.page++,this.moreData&&(this.loading="loading",setTimeout((()=>{this.getMessageList()}),1e3)))},getMessageList(){this.$api.msgApi.getMessageList({is_group:this.is_group,toContactId:this.contact.id,page:this.page,limit:this.limit}).then((e=>{1==this.page&&(ce.msgList=[]),e.data.slice().reverse().forEach((e=>{ce.msgList.unshift(e)})),this.loading="more",e.data.length<this.limit&&(this.moreData=!1,this.loading="noMore"),this.$nextTick((()=>{1==this.page?this.scrollToBottom():this.getScrollHeight()}))}))},moreOption(e){this.timer=setTimeout((()=>{this.curMsg=e,(e.type="text")?this.copyTxt="消息":this.copyTxt="链接",this.modelName="moreOpt"}),1e3)},undoMsg(){let e=this.curMsg;this.modelName="",this.$api.msgApi.undoMessage({id:e.id}).then((t=>{const s={id:e.id,type:"event",is_undo:1,content:"你撤回了一条消息",oldContent:e.content,toContactId:e.toContactId};this.updateMessage(s)}))},copyMsg(){this.modelName="",P({data:this.curMsg.content,showToast:!0})},reEdit(e){this.$refs.imInput.inputMsg=e,this.$refs.imInput.isFocus=!0},scrollToBottom(){const e=$().in(this);setTimeout((()=>{e.select(".cu-chat").boundingClientRect(),e.exec((e=>{let t=e[0].height??999999;this.scrollTop=t+3e3}))}),10)},openDetails(){m({url:"/pages/message/detail?id="+this.contact.id+"&is_group="+this.contact.is_group})},fileSize(e){return this.$util.getFileSize(e)},emojiToHtml(e){let t=this.emojiMap;return e.replace(/\[!(\w+)\]/gi,(function(e,s){var i=s;return t[i]?'<img class=\'mr-5\' style="width:18px;height:18px" emoji-name="'.concat(s,'" src="').concat(t[i],'" />'):"[!".concat(s,"]")}))},reSend(e){e.status="going",this.sendMessage(JSON.parse(JSON.stringify(e)),"")},sendMessage(e,t){if(!this.globalConfig.chatInfo.simpleChat&&0==this.is_group||!this.nospeak())return void l({title:"系统已关闭单聊，或者群已开启禁言，无法发送消息",icon:"none"});let s=this.user;s.id=s.user_id,e.fromUser=s,e.from_user=this.user.user_id,e.toContactId=this.contact.id,e.is_group=this.contact.is_group,this.messageList.push(e),this.scrollToBottom();if("text"==e.type)this.$api.msgApi.sendMessage(e).then((e=>{0==e.code?this.updateMessage(e.data):401==e.code&&(this.messageList.pop(),l({title:e.msg,icon:"none"}))})).catch((t=>{this.sendFailed(e)}));else if(["image","file","video","voice"].includes(e.type)){if(e.fileSize>1024e4)return l({title:"文件大小不能超过10M",icon:"error"});A({url:this.$api.msgApi.uploadUrl,filePath:e.content,name:"file",header:{authToken:L("authToken")},formData:{message:JSON.stringify(e)},success:e=>{let t=JSON.parse(e.data);0==t.code?this.updateMessage(t.data):401==t.code&&(this.messageList.pop(),l({title:t.msg,icon:"none"}))},fail:t=>{this.sendFailed(e)}})}},sendFailed(e){e.status="failed",this.updateMessage(JSON.parse(JSON.stringify(e)))},closeModel(){this.videoUrl="",this.videoModel=!1},handlePlay(e){this.videoUrl=e.content,this.videoModel=!0,ne.stop(),this.playIndex=-1},sendTime:function(e){return this.$util.timeFormat(e)},playVoice:function(e){var t=e.currentTarget.dataset.voice,s=e.currentTarget.dataset.index;if(-1==this.playIndex)return this.playNow(t,s);this.playIndex==s?(ne.stop(),this.playIndex=-1):(ne.stop(),this.playIndex=-1,this.playNow(t,s))},playNow:function(e,t){return this.playIndex=t,ne.autoplay=!0,ne.src=e,ne.play(),!0},showImgs:function(e){for(var t=[],s=e.currentTarget.dataset.img,i=0;i<this.messageList.length;i++)"image"==this.messageList[i].type&&t.push(this.messageList[i].content);z({urls:t,current:s})},closeInput(e){this.boxStatus++},nospeak(){return!(1==this.is_group&&this.contact.setting.nospeak>0)||(1==this.contact.setting.nospeak&&2==this.contact.role||2==this.contact.setting.nospeak&&1==this.contact.role)}}},[["render",function(e,o,a,n,c,l){const r=V("Tags"),d=V("statusPoint"),u=J,m=i,h=V("cu-custom"),x=K(S("uni-load-more"),G),T=V("im-user"),v=K(S("mp-html"),Y),M=j,B=V("imItem"),L=q,R=U,H=V("imInput");return t(),s(m,null,{default:p((()=>[g(h,{bgColor:"bg-white",isBack:!0,class:"cu-header"},{backText:p((()=>[])),content:p((()=>[g(m,{class:"im-flex im-justify-content-center im-align-items-center"},{default:p((()=>[1==c.is_group?(t(),s(r,{key:0,text:"群聊",size:"mini"})):y("",!0),0==c.is_group&&1==c.contact.is_online&&1==c.globalConfig.chatInfo.online?(t(),s(d,{key:1,type:"success"})):y("",!0),g(u,{class:"text-overflow"},{default:p((()=>[_(k(c.contact.displayName),1)])),_:1})])),_:1})])),right:p((()=>[g(m,{class:"cuIcon-more mr-10 f-16",onClick:l.openDetails},null,8,["onClick"])])),_:1}),g(R,{ref:"scrollView","scroll-y":"true","scroll-anchoring":!0,"scroll-top":c.scrollTop,onScroll:l.scrollChat,style:w({height:l.scrollH+"rpx",position:"fixed",bottom:c.bottomHeight+"px"})},{default:p((()=>[g(m,{class:"cu-chat",style:w({paddingBottom:c.paddingB+"px"}),onClick:l.closeInput,id:"more-oprate"},{default:p((()=>[g(x,{status:c.loading},null,8,["status"]),(t(!0),b(C,null,I(c.messageList,((i,o)=>(t(),b(C,{key:o},["event"==i.type?(t(),s(m,{key:0,class:"cu-info"},{default:p((()=>[_(k(i.content)+" ",1),1==i.is_undo&&l.getTime()-i.sendTime<12e4?(t(),s(u,{key:0,class:"c-primary",onClick:e=>l.reEdit(i.oldContent??"")},{default:p((()=>[_("重新编辑")])),_:2},1032,["onClick"])):y("",!0)])),_:2},1024)):(t(),s(m,{key:1,class:f(["cu-item",[i.fromUser.id==c.user.user_id?"im-rows-reverse self im-justify-content-start":""]])},{default:p((()=>[g(T,{info:i.fromUser},null,8,["info"]),g(m,{class:"main im-wrap",onTouchstart:e=>l.moreOption(i),onTouchend:l.endTimer},{default:p((()=>[i.fromUser.id!=c.user.user_id?(t(),s(m,{key:0,class:"f-12 c-666",style:{width:"100%","margin-bottom":"6rpx"}},{default:p((()=>[_(k(i.fromUser.realname),1)])),_:2},1024)):y("",!0),"text"==i.type?(t(),s(m,{key:1,class:f(["content shadow",[i.fromUser.id==c.user.user_id?"bg-green":""]])},{default:p((()=>[g(v,{content:l.emojiToHtml(i.content),class:"im-flex"},null,8,["content"])])),_:2},1032,["class"])):"image"==i.type?(t(),s(M,{key:2,src:i.content,class:"radius",mode:"widthFix",onClick:l.showImgs,"data-img":i.content},null,8,["src","onClick","data-img"])):"voice"==i.type?(t(),s(m,{key:3,class:f(["im-voice-msg im-flex im-rows im-nowrap im-align-items-center radius-20",[o==c.playIndex?"linear-green":"",i.fromUser.id==c.user.user_id?"im-rows-reverse":""]]),"data-voice":i.content,"data-index":o,onClick:l.playVoice,style:w({width:3*i.extends.duration+"px"})},{default:p((()=>[g(u,{class:f(["f-16 cuIcon-subscription rotate45",[o==c.playIndex?"c-white":"",i.fromUser.id==c.user.user_id?"rotate225":""]])},null,8,["class"]),g(u,{class:f(["im-voice-msg-text",[o==c.playIndex?"c-white":""]])},{default:p((()=>[_(k(i.extends.duration)+' "',1)])),_:2},1032,["class"])])),_:2},1032,["class","data-voice","data-index","onClick","style"])):"video"==i.type?(t(),s(m,{key:4},{default:p((()=>[g(m,{class:"course-video radius-10",onClick:e=>l.handlePlay(i)},{default:p((()=>[g(m,{class:"relative-shadow"},{default:p((()=>[g(m,{class:"cuIcon-video icon-center f-28 c-white"})])),_:1}),g(M,{src:i.extends.poster,class:"",mode:"heightFix"},null,8,["src"])])),_:2},1032,["onClick"])])),_:2},1024)):"file"==i.type?(t(),s(m,{key:5},{default:p((()=>[g(m,{class:"file-card bg-white radius-10 im-flex im-justify-content-start pd-10 im-align-items-center",onClick:t=>e.preview(i)},{default:p((()=>[g(m,{class:"file-icon cuIcon-text f-36"}),g(m,{class:"im-flex im-columns ml-10"},{default:p((()=>[g(m,{class:"text-overflow file-name"},{default:p((()=>[_(k(i.fileName),1)])),_:2},1024),g(m,{class:"text-gray file-size f-12"},{default:p((()=>[_(k(l.fileSize(i.fileSize)),1)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"])])),_:2},1024)):"webrtc"==i.type?(t(),s(m,{key:6,onClick:e=>l.calling(i.extends.type),class:f(["im-voice-msg im-flex im-rows im-nowrap im-align-items-center radius-20",[i.fromUser.id==c.user.user_id?"im-rows-reverse":""]])},{default:p((()=>[g(u,{class:f(["f-16",[1==i.extends.type?"cuIcon-record":"cuIcon-dianhua",i.fromUser.id==c.user.user_id?"rotate180":""]])},null,8,["class"]),g(u,{class:"im-voice-msg-text"},{default:p((()=>[_(k(i.content),1)])),_:2},1024)])),_:2},1032,["onClick","class"])):(t(),s(B,{key:7,item:i,index:o,isSelf:!0},null,8,["item","index"]))])),_:2},1032,["onTouchstart","onTouchend"]),i.fromUser.id==c.user.user_id?(t(),s(m,{key:0,class:"mt-10 f-20"},{default:p((()=>["going"==i.status?(t(),s(m,{key:0,class:"cuIcon-icloading icon-spin c-999"})):y("",!0),"failed"==i.status?(t(),s(m,{key:1,class:"cuIcon-infofill c-red",onClick:e=>l.reSend(i)},null,8,["onClick"])):y("",!0)])),_:2},1024)):y("",!0),g(m,{class:"date"},{default:p((()=>[0==i.is_group&&i.fromUser.id==c.user.user_id?(t(),s(u,{key:0,class:f(i.is_read?"c-success":"c-gray")},{default:p((()=>[_(k(i.is_read?"已读":"未读"),1)])),_:2},1032,["class"])):y("",!0),_(" "+k(l.sendTime(i.sendTime)),1)])),_:2},1024)])),_:2},1032,["class"]))],64)))),128)),c.videoModel?(t(),s(m,{key:0,class:"video-model im-flex im-align-items-center"},{default:p((()=>[g(m,{class:"c-white radius-16 close-model",onClick:l.closeModel},{default:p((()=>[_("关闭 ")])),_:1},8,["onClick"]),g(L,{class:"video-box",src:c.videoUrl,controls:"",autoplay:"autoplay"},null,8,["src"])])),_:1})):y("",!0)])),_:1},8,["style","onClick"])])),_:1},8,["scroll-top","onScroll","style"]),g(m,{id:"im-input"},{default:p((()=>[g(H,{onSend:l.sendMessage,onSetPad:l.setPad,boxStatus:c.boxStatus,contact:c.contact,ref:"imInput"},null,8,["onSend","onSetPad","boxStatus","contact"])])),_:1}),g(m,{class:f(["cu-modal bottom-modal","moreOpt"==c.modelName?"show":""]),onClick:o[3]||(o[3]=e=>c.modelName="")},{default:p((()=>[g(m,{class:"cu-dialog"},{default:p((()=>[g(m,{class:"manage-content"},{default:p((()=>[g(m,{class:"cu-list menu bg-white"},{default:p((()=>[l.getTime()-c.curMsg.sendTime<12e4&&c.curMsg.fromUser.id==c.user.user_id?(t(),s(m,{key:0,class:"cu-item",onClick:o[0]||(o[0]=e=>l.undoMsg())},{default:p((()=>[g(m,{class:"content padding-tb-sm"},{default:p((()=>[g(u,{class:"cuIcon-forward"}),g(u,null,{default:p((()=>[_("撤回消息")])),_:1})])),_:1})])),_:1})):y("",!0),g(m,{class:"cu-item",onClick:o[1]||(o[1]=e=>l.copyMsg())},{default:p((()=>[g(m,{class:"content padding-tb-sm"},{default:p((()=>[g(u,{class:"cuIcon-copy"}),g(u,null,{default:p((()=>[_("复制"+k(c.copyTxt),1)])),_:1})])),_:1})])),_:1}),g(m,{class:"parting-line-5"}),g(m,{class:"cu-item",onClick:o[2]||(o[2]=e=>c.modelName="")},{default:p((()=>[g(m,{class:"content padding-tb-sm"},{default:p((()=>[g(u,{class:"c-red"},{default:p((()=>[_("取消")])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["class"])])),_:1})}],["__scopeId","data-v-941a3bc8"]]);export{pe as default};
